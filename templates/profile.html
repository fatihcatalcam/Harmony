<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ user.display_name }}'s Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1db954',
                        dark: '#0b1117',
                        card: '#121212',
                        accent: '#4dd0e1',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    </link>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        /* Background Glows matching index1 */
        .glow-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            z-index: -10;
            opacity: 0.4;
        }
    </style>
</head>

<body class="min-h-screen bg-[#0b1117] text-[#f5f5f5] relative overflow-x-hidden font-sans">

    <!-- Background Glows -->
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
        <div class="glow-blob bg-[#1db954] w-[400px] h-[400px] -top-32 -left-32 opacity-30"></div>
        <div class="glow-blob bg-[#4dd0e1] w-[350px] h-[350px] top-1/2 -right-32 opacity-25"></div>
        <div class="glow-blob bg-[#1db954] w-[300px] h-[300px] -bottom-32 left-1/3 opacity-20"></div>
    </div>

    <div class="max-w-6xl mx-auto px-6 py-10">
        <div class="flex items-center justify-between mb-8">
            <a href="/index1"
                class="inline-flex items-center gap-2 px-5 py-2.5 text-sm font-semibold tracking-wide text-white bg-white/5 hover:bg-white/10 rounded-full border border-white/10 transition backdrop-blur-md">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Discover</span>
            </a>
            <div class="hidden sm:flex items-center gap-3 text-gray-400 text-sm">
                <i class="fas fa-music text-lg text-[#1db954]"></i>
                <span>Harmony keeps your vibe alive</span>
            </div>
        </div>

        <div class="grid lg:grid-cols-[1.1fr_1.3fr] gap-8">
            <!-- Profile Card -->
            <section
                class="relative overflow-hidden rounded-3xl border border-white/10 bg-[#121212] bg-opacity-90 backdrop-blur-xl shadow-2xl">

                <div
                    class="absolute inset-0 bg-gradient-to-br from-[#1db954]/10 via-transparent to-black/50 pointer-events-none">
                </div>

                <div class="relative p-8">
                    <div class="flex flex-col items-center text-center">
                        <div class="relative">
                            <span
                                class="absolute inset-0 rounded-full bg-[#1db954]/30 blur-2xl transform scale-110"></span>
                            <img src="{{ user.profile_image }}" alt="Profile image of {{ user.display_name }}"
                                class="relative w-36 h-36 rounded-full object-cover ring-4 ring-[#1db954]/50 shadow-2xl bg-[#0b1117]">
                        </div>
                        <h1 class="mt-6 text-3xl font-bold tracking-tight text-white">{{ user.display_name }}</h1>
                        <p class="mt-3 text-base text-gray-300 leading-relaxed">{{ user.bio or "Bio: No bio available."
                            }}</p>

                        <div class="mt-6 w-full grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-300">
                            <div class="flex items-center gap-3 rounded-2xl bg-white/5 border border-white/5 px-4 py-3">
                                <i class="fas fa-birthday-cake text-[#1db954]"></i>
                                <div class="text-left">
                                    <p class="font-bold uppercase tracking-widest text-[10px] text-gray-500">Age</p>
                                    <p class="text-lg font-medium">{{ user.age or "N/A" }}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 rounded-2xl bg-white/5 border border-white/5 px-4 py-3">
                                <i class="fas fa-map-marker-alt text-[#1db954]"></i>
                                <div class="text-left">
                                    <p class="font-bold uppercase tracking-widest text-[10px] text-gray-500">Location
                                    </p>
                                    <p class="text-lg font-medium">{{ user.location or "N/A" }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 flex flex-wrap justify-center gap-3 text-xs font-semibold tracking-wide">
                            <span
                                class="inline-flex items-center gap-2 rounded-full bg-[#1db954]/10 border border-[#1db954]/20 px-4 py-2 text-[#1db954]">
                                <i class="fas fa-headphones"></i>
                                {{ (user.top_tracks or []) | length }} top tracks
                            </span>
                            <span
                                class="inline-flex items-center gap-2 rounded-full bg-[#1db954]/10 border border-[#1db954]/20 px-4 py-2 text-[#1db954]">
                                <i class="fas fa-user-friends"></i>
                                {{ (user.top_artists or []) | length }} favorite artists
                            </span>
                            <span
                                class="inline-flex items-center gap-2 rounded-full bg-[#1db954]/10 border border-[#1db954]/20 px-4 py-2 text-[#1db954]">
                                <i class="fas fa-tags"></i>
                                {{ (user.genres or []) | length }} genres loved
                            </span>
                        </div>

                        {% if user.id == session.get('user_id') %}
                        <button onclick="toggleEditForm()"
                            class="mt-8 inline-flex items-center gap-2 rounded-full bg-[#1db954] px-8 py-3 text-sm font-bold text-white shadow-lg shadow-[#1db954]/25 transition hover:bg-[#169943] hover:-translate-y-0.5 transform">
                            <i class="fas fa-edit"></i>
                            Edit Profile
                        </button>
                        {% endif %}

                        <div class="mt-10 w-full space-y-6 text-left">
                            <div class="rounded-3xl border border-white/5 bg-[#0b1117]/50 p-6 shadow-xl">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg font-bold text-white">Top Artists</h2>
                                    <span
                                        class="rounded-full bg-white/5 border border-white/5 px-3 py-1 text-xs font-bold text-gray-400">
                                        {{ (user.top_artists or []) | length }}
                                    </span>
                                </div>
                                <div class="space-y-3">
                                    {% for artist in (user.top_artists or [])[:4] %}
                                    <div
                                        class="flex items-center gap-3 rounded-xl border border-white/5 bg-white/5 p-3 transition hover:border-[#1db954]/50 hover:bg-[#1db954]/10 group">
                                        <img src="{{ artist.image }}" alt="Image of artist {{ artist.name }}"
                                            class="h-12 w-12 rounded-lg object-cover shadow-md group-hover:scale-105 transition">
                                        <div>
                                            <a href="{{ artist.spotify_url }}" target="_blank"
                                                class="font-semibold text-white group-hover:text-[#1db954] transition">{{
                                                artist.name }}</a>
                                            <p class="text-xs text-gray-500 mt-0.5 truncate max-w-[150px]">{{ ",
                                                ".join(artist.genres) }}</p>
                                        </div>
                                    </div>
                                    {% else %}
                                    <p class="text-sm text-gray-500 italic">No favorite artists found.</p>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="rounded-3xl border border-white/5 bg-[#0b1117]/50 p-6 shadow-xl">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg font-bold text-white">Top Genres</h2>
                                    <span
                                        class="rounded-full bg-white/5 border border-white/5 px-3 py-1 text-xs font-bold text-gray-400">
                                        {{ (user.genres or []) | length }}
                                    </span>
                                </div>
                                <p class="text-xs text-gray-400 mb-4">A palette of sounds shaping {{ user.display_name
                                    }}'s playlists.</p>
                                <ul class="flex flex-wrap gap-2">
                                    {% for genre in (user.genres or []) %}
                                    <li
                                        class="rounded-md bg-white/5 border border-white/10 px-3 py-1.5 text-xs font-medium text-gray-300 uppercase tracking-wide">
                                        {{ genre }}</li>
                                    {% else %}
                                    <li class="text-sm text-gray-500 italic">No genres found.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Form -->
                    <div id="edit-form" class="hidden mt-8">
                        <form id="profile-form" action="/update_profile" method="POST"
                            class="space-y-5 rounded-3xl border border-white/10 bg-[#0b1117]/80 p-6 shadow-2xl">
                            <div>
                                <label for="bio"
                                    class="mb-2 block text-xs font-bold uppercase tracking-widest text-[#1db954]">Bio</label>
                                <textarea id="bio" name="bio"
                                    class="w-full rounded-xl border border-white/10 bg-white/5 p-4 text-sm text-white placeholder-gray-600 focus:border-[#1db954] focus:ring-1 focus:ring-[#1db954] focus:outline-none transition"
                                    rows="3">{{ user.bio }}</textarea>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                <div>
                                    <label for="age"
                                        class="mb-2 block text-xs font-bold uppercase tracking-widest text-[#1db954]">Age</label>
                                    <input type="number" id="age" name="age"
                                        class="w-full rounded-xl border border-white/10 bg-white/5 p-4 text-sm text-white placeholder-gray-600 focus:border-[#1db954] focus:ring-1 focus:ring-[#1db954] focus:outline-none transition"
                                        value="{{ user.age }}">
                                </div>
                                <div>
                                    <label for="location"
                                        class="mb-2 block text-xs font-bold uppercase tracking-widest text-[#1db954]">Location</label>
                                    <input type="text" id="location" name="location"
                                        class="w-full rounded-xl border border-white/10 bg-white/5 p-4 text-sm text-white placeholder-gray-600 focus:border-[#1db954] focus:ring-1 focus:ring-[#1db954] focus:outline-none transition"
                                        value="{{ user.location }}">
                                </div>
                            </div>
                            <button type="submit"
                                class="w-full rounded-xl bg-[#1db954] px-6 py-3.5 text-sm font-bold text-white shadow-lg shadow-[#1db954]/20 transition hover:bg-[#169943] hover:-translate-y-0.5">
                                Save Changes
                            </button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Listening Insights -->
            <section class="space-y-8">
                <div class="rounded-3xl border border-white/10 bg-[#121212]/90 p-8 shadow-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-white">Top Tracks</h2>
                        <span
                            class="rounded-full bg-white/5 border border-white/5 px-3 py-1 text-xs font-bold text-gray-400">
                            {{ (user.top_tracks or []) | length }} tracks
                        </span>
                    </div>
                    <p class="text-sm text-gray-400 mb-6">Dive into the songs that define {{ user.display_name }}'s
                        current vibe.</p>
                    <div class="space-y-4">
                        {% for track in (user.top_tracks or []) %}
                        <div
                            class="flex items-center gap-4 rounded-xl border border-white/5 bg-white/5 p-4 transition hover:border-[#1db954]/40 hover:bg-[#1db954]/5 group">
                            <img src="{{ track.image }}" alt="Album cover of track {{ track.name }}"
                                class="h-16 w-16 rounded-lg object-cover shadow-md group-hover:scale-105 transition">
                            <div class="flex-1 min-w-0">
                                <a href="{{ track.spotify_url }}" target="_blank"
                                    class="text-lg font-bold text-white group-hover:text-[#1db954] transition truncate block">{{
                                    track.name }}</a>
                                <p class="text-[10px] uppercase tracking-widest text-gray-500 mt-1">Album</p>
                                <p class="text-sm text-gray-300 truncate">{{ track.album }}</p>
                            </div>
                            <div class="hidden sm:flex flex-col items-end text-right text-xs text-gray-500">
                                <span class="uppercase tracking-widest text-[10px] mb-1">Artists</span>
                                <p class="text-sm text-gray-300 font-medium truncate max-w-[150px]">{{ ",
                                    ".join(track.artists) }}</p>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-sm text-gray-500 italic">No top tracks found.</p>
                        {% endfor %}
                    </div>
                </div>

            </section>
        </div>
    </div>

    <footer class="border-t border-white/5 bg-[#0b1117] py-8 text-center text-sm text-gray-500">
        <p>© 2025 Harmony · Built with <span class="text-[#1db954]">❤️</span> for music lovers.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function toggleEditForm() {
                const form = document.getElementById('edit-form');
                form.classList.toggle('hidden');
            }
            window.toggleEditForm = toggleEditForm;

            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData(this);

                    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                    fetch('/update_profile', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken
                        },
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.message === "Profile updated successfully!") {
                                location.reload();
                            } else {
                                alert("Error: " + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                });
            }
        });
    </script>

</body>

</html>